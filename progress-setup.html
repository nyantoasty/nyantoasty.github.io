<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Tracking Setup - Arachne Pattern Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-purple-400 mb-2">🧶 Progress Tracking Setup</h1>
            <p class="text-gray-300">Initialize Firestore collections for individual progress tracking</p>
        </header>

        <div class="max-w-4xl mx-auto">
            <!-- Status Display -->
            <div id="status-container" class="mb-8">
                <div id="status-card" class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 text-purple-300">Setup Status</h2>
                    <div id="status-content" class="text-gray-300">
                        Ready to initialize progress tracking system...
                    </div>
                </div>
            </div>

            <!-- Setup Options -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold mb-3 text-green-400">🚀 Initialize System</h3>
                    <p class="text-gray-300 mb-4">Set up all collections with sample data for testing the new progress tracking system.</p>
                    <button id="setup-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                        Run Setup
                    </button>
                </div>

                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                    <h3 class="text-lg font-semibold mb-3 text-red-400">🧹 Clear Data</h3>
                    <p class="text-gray-300 mb-4">Clear existing progress data for testing (use with caution).</p>
                    <button id="clear-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium" disabled>
                        Clear Data
                    </button>
                </div>
            </div>

            <!-- Features Overview -->
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-8">
                <h3 class="text-lg font-semibold mb-4 text-blue-400">✨ What This Setup Creates</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-medium text-white mb-2">Collections:</h4>
                        <ul class="text-gray-300 space-y-1 text-sm">
                            <li>• <code>users</code> - User profiles and preferences</li>
                            <li>• <code>patterns</code> - Pattern storage with sharing support</li>
                            <li>• <code>pattern_access</code> - Permission management</li>
                            <li>• <code>user_pattern_progress</code> - Individual progress tracking</li>
                            <li>• <code>pattern_shares</code> - Sharing requests and history</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-medium text-white mb-2">Sample Data:</h4>
                        <ul class="text-gray-300 space-y-1 text-sm">
                            <li>• 3 users with different progress levels</li>
                            <li>• 1 Sea Witch pattern with sharing enabled</li>
                            <li>• Individual progress for each user</li>
                            <li>• Access permissions and sharing records</li>
                            <li>• Sample analytics data</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <h3 class="text-lg font-semibold mb-4 text-yellow-400">📋 Next Steps</h3>
                <ol class="text-gray-300 space-y-2">
                    <li><strong>1. Run Setup:</strong> Click "Run Setup" to create all collections and sample data</li>
                    <li><strong>2. Security Rules:</strong> Copy the security rules from <code>firestore-security-rules.js</code> to your Firebase Console</li>
                    <li><strong>3. Test:</strong> Load the main pattern viewer and test individual progress tracking</li>
                    <li><strong>4. Verify:</strong> Check that different users have separate progress on the same pattern</li>
                </ol>
                
                <div class="mt-4 p-4 bg-blue-900/30 border border-blue-700 rounded-lg">
                    <p class="text-blue-200 text-sm">
                        <strong>Security Rules:</strong> Don't forget to update your Firestore Security Rules in the Firebase Console 
                        with the rules from <code>scripts/firestore-security-rules.js</code> to ensure proper data protection.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Console Output -->
    <div id="console-output" class="fixed bottom-0 left-0 right-0 bg-black bg-opacity-90 text-green-400 p-4 font-mono text-sm max-h-64 overflow-y-auto hidden">
        <div class="flex justify-between items-center mb-2">
            <span class="text-green-300">Console Output:</span>
            <button id="hide-console" class="text-gray-400 hover:text-white">✕</button>
        </div>
        <div id="console-content"></div>
    </div>

    <script type="module">
        import { setupProgressTracking, clearProgressData } from './scripts/progress-setup.js';

        const statusContent = document.getElementById('status-content');
        const setupBtn = document.getElementById('setup-btn');
        const clearBtn = document.getElementById('clear-btn');
        const consoleOutput = document.getElementById('console-output');
        const consoleContent = document.getElementById('console-content');
        const hideConsole = document.getElementById('hide-console');

        let originalConsoleLog = console.log;
        let originalConsoleError = console.error;

        // Override console to show output in UI
        function setupConsoleCapture() {
            console.log = function(...args) {
                originalConsoleLog(...args);
                addToConsole('log', args.join(' '));
            };

            console.error = function(...args) {
                originalConsoleError(...args);
                addToConsole('error', args.join(' '));
            };
        }

        function addToConsole(type, message) {
            const div = document.createElement('div');
            div.className = type === 'error' ? 'text-red-400' : 'text-green-400';
            div.textContent = message;
            consoleContent.appendChild(div);
            consoleContent.scrollTop = consoleContent.scrollHeight;
            
            if (consoleOutput.classList.contains('hidden')) {
                consoleOutput.classList.remove('hidden');
            }
        }

        function updateStatus(message, type = 'info') {
            const colors = {
                info: 'text-gray-300',
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400'
            };
            
            statusContent.innerHTML = `<span class="${colors[type]}">${message}</span>`;
        }

        setupBtn.addEventListener('click', async () => {
            setupBtn.disabled = true;
            setupBtn.textContent = 'Setting up...';
            updateStatus('Initializing progress tracking system...', 'info');
            
            setupConsoleCapture();

            try {
                await setupProgressTracking();
                updateStatus('✅ Progress tracking system initialized successfully!', 'success');
                setupBtn.textContent = 'Setup Complete';
                clearBtn.disabled = false;
            } catch (error) {
                updateStatus(`❌ Setup failed: ${error.message}`, 'error');
                setupBtn.disabled = false;
                setupBtn.textContent = 'Retry Setup';
            }
        });

        clearBtn.addEventListener('click', async () => {
            if (!confirm('Are you sure you want to clear existing progress data? This cannot be undone.')) {
                return;
            }

            clearBtn.disabled = true;
            clearBtn.textContent = 'Clearing...';
            updateStatus('Clearing existing data...', 'warning');

            try {
                await clearProgressData();
                updateStatus('✅ Data cleared successfully!', 'success');
                clearBtn.textContent = 'Data Cleared';
                setupBtn.disabled = false;
                setupBtn.textContent = 'Run Setup';
            } catch (error) {
                updateStatus(`❌ Clear failed: ${error.message}`, 'error');
                clearBtn.disabled = false;
                clearBtn.textContent = 'Retry Clear';
            }
        });

        hideConsole.addEventListener('click', () => {
            consoleOutput.classList.add('hidden');
        });

        // Initial status
        updateStatus('Ready to initialize progress tracking system. Click "Run Setup" to begin.', 'info');
    </script>
</body>
</html>