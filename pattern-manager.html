<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pattern Manager - Pattern Hub</title>
    <link rel="icon" type="image/png" href="/assets/icons/yarn-ball-icon.png">
    <link rel="stylesheet" href="css/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        body.has-unified-header {
            padding-top: 3.5rem;
        }
        .json-editor {
            font-family: 'Roboto Mono', monospace;
            background: #1f2937;
            color: #f9fafb;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.875rem;
            line-height: 1.6;
        }
        .json-editor:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
        .preview-section {
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #10b981; }
        .status-error { background-color: #ef4444; }
        .status-warning { background-color: #f59e0b; }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-600 via-purple-700 to-blue-800 has-unified-header">
    <!-- Unified Header Component -->
    <div id="header-placeholder"></div>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-6 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Left Panel: JSON Input -->
            <div class="space-y-6">
                <div class="bg-white bg-opacity-10 backdrop-blur-md rounded-xl p-6 border border-white border-opacity-20">
                    <h2 class="text-xl font-semibold text-white mb-4">Upload Pattern JSON</h2>
                    
                    <div class="mb-4">
                        <label for="pattern-json" class="block text-sm font-medium text-white text-opacity-90 mb-2">
                            Paste your pattern JSON here:
                        </label>
                        <textarea 
                            id="pattern-json" 
                            class="json-editor w-full h-96 resize-none"
                            placeholder='{
  "metadata": {
    "name": "My Pattern",
    "author": "Pattern Designer",
    "craft": "knitting",
    "maxSteps": 50
  },
  "glossary": {
    "k": {
      "name": "Knit",
      "description": "Knit stitch.",
      "stitchesUsed": 1,
      "stitchesCreated": 1
    }
  },
  "steps": [...]
}'></textarea>
                    </div>

                    <div class="flex space-x-3">
                        <button id="validate-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            Validate JSON
                        </button>
                        <button id="clear-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            Clear
                        </button>
                    </div>
                </div>

                <!-- Validation Status -->
                <div id="validation-status" class="bg-white bg-opacity-10 backdrop-blur-md rounded-xl p-4 border border-white border-opacity-20 hidden">
                    <h3 class="text-lg font-medium text-white mb-2">Validation Results</h3>
                    <div id="validation-messages" class="space-y-2"></div>
                </div>
            </div>

            <!-- Right Panel: Preview -->
            <div class="space-y-6">
                <div class="preview-section rounded-xl p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Pattern Preview</h2>
                    
                    <div id="pattern-preview" class="space-y-4">
                        <div class="text-center text-gray-500 py-8">
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p>Validate your JSON to see pattern preview</p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div id="action-buttons" class="bg-white bg-opacity-10 backdrop-blur-md rounded-xl p-6 border border-white border-opacity-20 hidden">
                    <div class="flex space-x-4">
                        <button id="upload-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            Upload to Firestore
                        </button>
                        <button id="cancel-upload-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors hidden">
                            Cancel & Delete
                        </button>
                    </div>
                    <p class="text-white text-opacity-75 text-sm mt-3 text-center">
                        Pattern will be uploaded as private. You can share it later.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-4 right-4 space-y-2 z-50"></div>

    <!-- Load unified header -->
    <script src="js/header-loader.js"></script>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBmI_9qHr18VWclwzomAUElLTmgJ_MCI3g",
            authDomain: "arachne-edda2.firebaseapp.com",
            projectId: "arachne-edda2",
            storageBucket: "arachne-edda2.firebasestorage.app",
            messagingSenderId: "285468127259",
            appId: "1:285468127259:web:9a1285684a1a6b9b1548be",
            measurementId: "G-208TQKEXGG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state
        let currentUser = null;
        let validatedPattern = null;
        let uploadedPatternId = null;

        // DOM elements
        const patternJsonTextarea = document.getElementById('pattern-json');
        const validateBtn = document.getElementById('validate-btn');
        const clearBtn = document.getElementById('clear-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const cancelUploadBtn = document.getElementById('cancel-upload-btn');
        const signInBtn = document.getElementById('sign-in-btn');
        const authStatus = document.getElementById('auth-status');
        const validationStatus = document.getElementById('validation-status');
        const validationMessages = document.getElementById('validation-messages');
        const patternPreview = document.getElementById('pattern-preview');
        const actionButtons = document.getElementById('action-buttons');

        // Auth state management
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                authStatus.innerHTML = `<span>Signed in as ${user.email}</span>`;
                signInBtn.textContent = 'Sign Out';
                uploadBtn.disabled = false;
            } else {
                authStatus.innerHTML = `<span class="opacity-75">Not signed in</span>`;
                signInBtn.textContent = 'Sign In';
                uploadBtn.disabled = true;
            }
        });

        // Authentication
        signInBtn.addEventListener('click', async () => {
            if (currentUser) {
                await signOut(auth);
            } else {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    showToast('Authentication failed: ' + error.message, 'error');
                }
            }
        });

        // JSON validation
        validateBtn.addEventListener('click', () => {
            const jsonText = patternJsonTextarea.value.trim();
            if (!jsonText) {
                showToast('Please paste JSON content first', 'warning');
                return;
            }

            try {
                const pattern = JSON.parse(jsonText);
                const validation = validatePatternSchema(pattern);
                
                displayValidationResults(validation);
                
                if (validation.isValid) {
                    validatedPattern = pattern;
                    displayPatternPreview(pattern);
                    actionButtons.classList.remove('hidden');
                    showToast('Pattern validated successfully!', 'success');
                } else {
                    validatedPattern = null;
                    actionButtons.classList.add('hidden');
                    showToast('Pattern validation failed', 'error');
                }
            } catch (error) {
                showToast('Invalid JSON: ' + error.message, 'error');
                displayValidationResults({
                    isValid: false,
                    errors: [`JSON Parse Error: ${error.message}`],
                    warnings: []
                });
            }
        });

        // Pattern schema validation
        function validatePatternSchema(pattern) {
            const errors = [];
            const warnings = [];

            // Check required top-level properties
            if (!pattern.metadata) errors.push('Missing required "metadata" section');
            if (!pattern.glossary) errors.push('Missing required "glossary" section');
            if (!pattern.steps || !Array.isArray(pattern.steps)) errors.push('Missing required "steps" array');

            // Validate metadata
            if (pattern.metadata) {
                if (!pattern.metadata.name) errors.push('metadata.name is required');
                if (!pattern.metadata.author) errors.push('metadata.author is required');
                if (!pattern.metadata.craft) errors.push('metadata.craft is required');
                if (!pattern.metadata.maxSteps) errors.push('metadata.maxSteps is required');
            }

            // Validate glossary
            if (pattern.glossary) {
                for (const [key, stitch] of Object.entries(pattern.glossary)) {
                    if (!stitch.name) errors.push(`glossary.${key}.name is required`);
                    if (!stitch.description) errors.push(`glossary.${key}.description is required`);
                    
                    // Check for new schema properties
                    if (stitch.stitchIndex !== undefined) {
                        warnings.push(`glossary.${key} uses deprecated "stitchIndex" property. Use "stitchesUsed" and "stitchesCreated" instead`);
                    }
                    if (stitch.stitchesUsed === undefined || stitch.stitchesCreated === undefined) {
                        errors.push(`glossary.${key} missing required "stitchesUsed" or "stitchesCreated" properties`);
                    }
                    if (stitch.stitchesUsed === undefined) warnings.push(`glossary.${key}.stitchesUsed is recommended`);
                    if (stitch.stitchesCreated === undefined) warnings.push(`glossary.${key}.stitchesCreated is recommended`);
                }
            }

            // Validate steps
            if (pattern.steps) {
                if (pattern.steps.length === 0) errors.push('Steps array cannot be empty');
                
                for (let i = 0; i < Math.min(pattern.steps.length, 5); i++) {
                    const step = pattern.steps[i];
                    if (step.step === undefined) errors.push(`steps[${i}].step is required`);
                    if (!step.type) errors.push(`steps[${i}].type is required`);
                    
                    if (step.type === 'regular') {
                        if (!step.instruction) errors.push(`steps[${i}].instruction is required for regular steps`);
                        if (step.startingStitchCount === undefined) warnings.push(`steps[${i}].startingStitchCount is recommended`);
                        if (step.endingStitchCount === undefined) warnings.push(`steps[${i}].endingStitchCount is recommended`);
                    }
                    
                    if (step.type === 'specialInstruction') {
                        if (!step.description) errors.push(`steps[${i}].description is required for special instructions`);
                    }
                }
            }

            return {
                isValid: errors.length === 0,
                errors,
                warnings
            };
        }

        // Display validation results
        function displayValidationResults(validation) {
            validationStatus.classList.remove('hidden');
            validationMessages.innerHTML = '';

            if (validation.isValid) {
                const successMsg = document.createElement('div');
                successMsg.className = 'flex items-center text-green-400';
                successMsg.innerHTML = '<span class="status-indicator status-success"></span>Pattern is valid and ready for upload';
                validationMessages.appendChild(successMsg);
            }

            validation.errors.forEach(error => {
                const errorMsg = document.createElement('div');
                errorMsg.className = 'flex items-center text-red-400';
                errorMsg.innerHTML = `<span class="status-indicator status-error"></span>${error}`;
                validationMessages.appendChild(errorMsg);
            });

            validation.warnings.forEach(warning => {
                const warningMsg = document.createElement('div');
                warningMsg.className = 'flex items-center text-yellow-400';
                warningMsg.innerHTML = `<span class="status-indicator status-warning"></span>${warning}`;
                validationMessages.appendChild(warningMsg);
            });
        }

        // Display pattern preview
        function displayPatternPreview(pattern) {
            const preview = document.createElement('div');
            preview.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">${pattern.metadata.name}</h3>
                        <p class="text-gray-600">by ${pattern.metadata.author}</p>
                        <div class="flex items-center space-x-4 text-sm text-gray-500 mt-2">
                            <span>ðŸ“„ ${pattern.steps.length} steps</span>
                            <span>ðŸ§¶ ${pattern.metadata.craft}</span>
                            <span>ðŸ“– ${Object.keys(pattern.glossary).length} stitches</span>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <h4 class="font-medium text-gray-700 mb-2">Glossary Preview</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            ${Object.entries(pattern.glossary).slice(0, 6).map(([key, stitch]) => `
                                <div class="bg-gray-50 p-2 rounded">
                                    <span class="font-mono font-semibold">${key}</span>
                                    <div class="text-gray-600">${stitch.name}</div>
                                </div>
                            `).join('')}
                            ${Object.keys(pattern.glossary).length > 6 ? `
                                <div class="bg-gray-50 p-2 rounded text-gray-500 text-center">
                                    +${Object.keys(pattern.glossary).length - 6} more...
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <h4 class="font-medium text-gray-700 mb-2">First Few Steps</h4>
                        <div class="space-y-2 text-sm">
                            ${pattern.steps.slice(0, 3).map(step => `
                                <div class="bg-gray-50 p-2 rounded">
                                    <span class="font-semibold">Step ${step.step}:</span>
                                    ${step.instruction || step.description || 'Special instruction'}
                                </div>
                            `).join('')}
                            ${pattern.steps.length > 3 ? `
                                <div class="bg-gray-50 p-2 rounded text-gray-500 text-center">
                                    ... and ${pattern.steps.length - 3} more steps
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            patternPreview.innerHTML = '';
            patternPreview.appendChild(preview);
        }

        // Upload to Firestore
        uploadBtn.addEventListener('click', async () => {
            if (!currentUser || !validatedPattern) return;

            try {
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Uploading...';

                const patternRef = doc(collection(db, 'patterns'));
                uploadedPatternId = patternRef.id;

                const patternData = {
                    id: uploadedPatternId,
                    ...validatedPattern,
                    createdBy: currentUser.uid,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    visibility: 'private',
                    shareCount: 0,
                    viewCount: 0,
                    forkCount: 0,
                    tags: [],
                    lastExportedAt: null,
                    exportCount: 0
                };

                await setDoc(patternRef, patternData);

                showToast('Pattern uploaded successfully!', 'success');
                cancelUploadBtn.classList.remove('hidden');
                uploadBtn.textContent = 'Uploaded âœ“';
                
                // Option to view the pattern
                setTimeout(() => {
                    if (confirm('Pattern uploaded! Would you like to view it now?')) {
                        window.location.href = `index.html?pattern=${uploadedPatternId}`;
                    }
                }, 1000);

            } catch (error) {
                console.error('Upload error:', error);
                showToast('Upload failed: ' + error.message, 'error');
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload to Firestore';
            }
        });

        // Cancel upload (delete from Firestore)
        cancelUploadBtn.addEventListener('click', async () => {
            if (!uploadedPatternId) return;

            if (confirm('Are you sure you want to delete this pattern from Firestore?')) {
                try {
                    await deleteDoc(doc(db, 'patterns', uploadedPatternId));
                    showToast('Pattern deleted successfully', 'success');
                    
                    // Reset UI
                    uploadedPatternId = null;
                    cancelUploadBtn.classList.add('hidden');
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'Upload to Firestore';
                    
                } catch (error) {
                    showToast('Delete failed: ' + error.message, 'error');
                }
            }
        });

        // Clear form
        clearBtn.addEventListener('click', () => {
            if (confirm('Clear all content?')) {
                patternJsonTextarea.value = '';
                validatedPattern = null;
                validationStatus.classList.add('hidden');
                patternPreview.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p>Validate your JSON to see pattern preview</p>
                    </div>
                `;
                actionButtons.classList.add('hidden');
            }
        });

        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            toast.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
            toast.textContent = message;
            
            document.getElementById('toast-container').appendChild(toast);
            
            // Animate in
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            
            // Remove after 4 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
    </script>
</body>
</html>