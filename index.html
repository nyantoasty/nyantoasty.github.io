<!DOCTYPE html>
<!-- Version: v2025-10-03- Correcting CORS errors + Vision status -->
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stitch Witch - v2025-10-03</title>
    <link rel="icon" type="image/png" href="/assets/icons/yarn-ball-icon.png">
    <link rel="shortcut icon" type="image/png" href="/assets/icons/yarn-ball-icon.png">
    <link rel="apple-touch-icon" href="/assets/icons/yarn-ball-icon.png">
    <meta name="theme-color" content="#8b5cf6">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Main Application Stylesheet - Three-Tier Token System -->
    <link rel="stylesheet" href="/css/main.css">
</head>
<body class="bg-primary text-secondary antialiased">

    <!-- Sidebar Toggle Button -->
    <button id="sidebar-toggle" title="Toggle pattern tools sidebar" class="fixed top-4 left-4 z-70 bg-secondary text-primary p-3 rounded-full shadow-lg border border-primary btn-secondary transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
    </button>

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-20 z-50 hidden"></div>

    <!-- Pattern Tools Sidebar -->
    <aside id="pattern-sidebar" class="fixed top-0 left-0 h-full w-80 bg-secondary border-r border-primary p-6 z-60 overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-primary">Pattern Tools</h2>
            <button id="sidebar-close" class="text-tertiary hover:text-primary text-2xl btn-icon">&times;</button>
        </div>
        
        <div class="space-y-6">
            <!-- Return to Current Row -->
            <div>
                <button id="return-to-row" class="w-full btn-accent font-medium py-2 px-4 rounded-lg transition-colors">
                    Return to Current Row
                </button>
            </div>

            <!-- Jump to Section -->
            <div>
                <h3 class="text-lg font-semibold text-secondary mb-3">Jump to Section</h3>
                <div class="space-y-2 text-sm">
                    <div class="sidebar-links">
                        <a href="#" data-section="section1" class="block text-accent hover:text-accent-hover py-1 link-primary">Section 1: Increasing</a>
                        <a href="#" data-section="section2" class="block text-accent hover:text-accent-hover py-1 link-primary">Section 2: Decreasing</a>
                    </div>
                </div>
            </div>

            <!-- Color Key -->
            <div>
                <h3 class="text-lg font-semibold text-secondary mb-3">Color Key</h3>
                <div id="sidebar-color-key" class="space-y-2 text-sm">
                    <!-- Will be populated dynamically from pattern data -->
                </div>
            </div>

            <!-- Materials & Notes -->
            <div>
                <h3 class="text-lg font-semibold text-secondary mb-3">Materials & Notes</h3>
                <div class="text-sm text-tertiary space-y-1">
                    <div>Yarn: Pattern specific</div>
                    <div>Needles: As specified</div>
                    <div>Gauge: Pattern specific</div>
                </div>
            </div>

            <!-- Stitch Glossary -->
            <div>
                <h3 class="text-lg font-semibold text-secondary mb-3">Stitch Glossary</h3>
                <div id="sidebar-glossary" class="text-sm space-y-2">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </aside>

    <!-- Standalone Generator: Always accessible -->
    <div id="standalone-generator" class="hidden max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="flex justify-between items-center mb-8 border-b border-primary pb-4">
            <h1 class="text-3xl font-bold text-primary">Pattern Tools</h1>
            <div class="flex space-x-2">
                <button id="back-to-main" class="btn-primary font-medium py-2 px-4 rounded-lg transition-colors">Back to Hub</button>
            </div>
        </header>
        
        <div class="grid gap-6 md:grid-cols-1 max-w-2xl mx-auto">
            <div class="bg-secondary p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-primary mb-4">AI Generator</h2>
                <p class="text-tertiary mb-4">Generate patterns from text descriptions using AI.</p>
                <a href="pattern-upload.html" class="w-full btn-special font-bold py-3 px-6 rounded-lg transition-colors inline-block text-center">
                    <i class="fas fa-magic mr-2"></i>Open AI Pattern Generator
                </a>
            </div>
        </div>
    </div>

    <!-- Auth Container: Shown when logged out -->
    <div id="auth-container" class="hidden min-h-screen flex items-center justify-center">
        <div class="text-center p-8 bg-secondary rounded-xl shadow-2xl border border-primary max-w-md mx-auto">
            <div class="mb-6">
                <div class="w-16 h-16 bg-accent rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-primary mb-2">Welcome Back</h1>
                <p class="text-tertiary">Sign in to access your pattern library</p>
            </div>
            
            <button id="login-btn" class="w-full btn-accent font-bold py-4 px-6 rounded-lg transition-colors flex items-center justify-center">
                <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48">
                    <path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path>
                    <path fill="#FF3D00" d="m6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path>
                    <path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.618-3.317-11.28-7.962l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path>
                    <path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C44.572 36.801 48 30.853 48 24c0-1.341-.138-2.65-.389-3.917z"></path>
                </svg>
                Continue with Google
            </button>
            
            <div class="mt-6 pt-6 border-t border-primary">
                <p class="text-xs text-muted">
                    By signing in, you agree to our terms of service and privacy policy
                </p>
            </div>
        </div>
    </div>

    <!-- App Container: Shown when logged in -->
    <div id="app-container" class="hidden max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 border-b border-gray-700 pb-4">
            <div class="text-center sm:text-left mb-4 sm:mb-0">
                <h1 class="text-3xl font-bold text-primary">Pattern Hub</h1>
                <p id="user-display" class="text-sm text-tertiary">Welcome!</p>
                <p class="text-xs text-muted">v2025-10-03 Correcting CORS errors + Vision status</p>
            </div>
            <div class="flex items-center space-x-4">
                 <nav id="app-nav" class="flex items-center space-x-2 bg-secondary p-1 rounded-lg">
                    <button data-view="viewer" class="tab-button active">Viewer</button>
                    <a href="pattern-upload.html" class="btn-accent font-medium py-2 px-4 rounded-lg transition-colors text-sm">Generator</a>
                </nav>
                <!-- DEVELOPMENT BUTTONS - HIDDEN IN PRODUCTION -->
                <!-- <button id="create-sample-progress-btn" class="bg-yellow-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-yellow-700 transition-colors text-sm">Create Sample Progress</button> -->
                <!-- <button id="recreate-progress-collection-btn" class="bg-purple-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors text-sm">Recreate Progress Collection</button> -->
                <button id="logout-btn" class="btn-danger font-medium py-2 px-4 rounded-lg transition-colors text-sm">Sign Out</button>
            </div>
        </header>

        <!-- VIEWER SECTION -->
        <div id="viewer-section">
            <header class="text-center mb-8">
                <!-- PROJECT MANAGER -->
                <div class="mb-6">
                    <div class="flex items-center justify-center space-x-4 mb-4">
                        <div class="flex-1 max-w-lg">
                            <label for="project-selector" class="block text-sm font-medium text-secondary mb-2">My Projects:</label>
                            <select id="project-selector" class="w-full bg-secondary border border-primary text-primary rounded-lg px-4 py-2 focus:ring-2 focus:ring-accent focus:border-accent">
                                <option value="">Loading your projects...</option>
                            </select>
                        </div>
                        <div class="flex space-x-2">
                            <button id="new-project-btn" class="btn-success px-4 py-2 rounded-lg text-sm transition-colors" title="Start New Project">
                                ‚ûï New
                            </button>
                            <button id="delete-project-btn" class="btn-warning px-4 py-2 rounded-lg text-sm transition-colors" disabled title="Archive or Permanently Delete Project">
                                üóÉÔ∏è Archive
                            </button>
                            <button id="show-archived-btn" class="btn-secondary px-4 py-2 rounded-lg text-sm transition-colors" title="View Archived Projects">
                                üì¶ Archived
                            </button>
                        </div>
                    </div>
                    
                    <!-- PROJECT INFO DISPLAY -->
                    <div id="project-info" class="hidden">
                        <h2 id="project-name" class="text-3xl font-bold text-primary mb-2"></h2>
                        <p id="project-pattern-info" class="text-lg pattern-accent mb-2"></p>
                        
                        <!-- PATTERN INFORMATION -->
                        <div class="mb-4 text-center">
                            <h3 id="pattern-name" class="text-2xl font-bold special-accent mb-1">Pattern Name</h3>
                            <p id="pattern-author" class="text-lg text-secondary">by Pattern Author</p>
                        </div>
                        
                        <div id="project-details" class="mt-3 p-4 bg-secondary rounded-lg border border-primary">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div><span class="text-tertiary">Pattern:</span> <span id="project-pattern-name" class="text-primary"></span></div>
                                <div><span class="text-tertiary">Started:</span> <span id="project-start-date" class="text-primary"></span></div>
                                <div><span class="text-tertiary">Last Updated:</span> <span id="project-last-update" class="text-primary"></span></div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-secondary">
                                <div class="text-sm text-tertiary">Progress: <span id="project-progress-summary" class="pattern-accent"></span></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NO PROJECT STATE -->
                    <div id="no-project-state" class="text-center py-8">
                        <h2 class="text-3xl font-bold text-primary mb-4">Welcome to Stitch Witch! ‚ú®</h2>
                        <p class="text-lg text-secondary mb-6">Create your first project to start tracking your crafting journey with patterns from our Firestore database</p>
                        <button id="welcome-new-project-btn" class="btn-success px-6 py-3 rounded-lg text-lg transition-colors">
                            ‚ûï Start Your First Project
                        </button>
                    </div>
                </div>
            </header>
            <main id="pattern-content" class="space-y-8 pb-40"></main>
            <div id="stitch-popup" class="hidden fixed bg-tertiary p-6 rounded-lg shadow-2xl z-50 border border-accent w-11/12 max-w-md">
                <button id="close-popup-btn" class="absolute top-2 right-3 text-2xl text-tertiary hover:text-primary btn-icon">&times;</button>
                <div id="popup-content"></div>
            </div>
        </div>
        
        <!-- PROJECT NOTES SIDEBAR -->
        <div id="notes-sidebar" class="fixed right-0 top-0 h-full w-96 bg-primary border-l border-primary transform translate-x-full transition-transform duration-300 ease-in-out z-40 overflow-y-auto">
            <div class="p-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-primary">Project Notes</h3>
                    <button id="close-notes-sidebar" title="Close notes sidebar" class="text-tertiary hover:text-primary btn-icon">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- General Notes -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-secondary mb-2">General Notes</label>
                    <textarea id="general-notes" class="w-full h-24 bg-secondary border border-primary text-primary rounded px-3 py-2 resize-none" placeholder="General project notes..."></textarea>
                </div>
                
                <!-- Current Row Note -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-secondary mb-2">Row <span id="current-row-note-label">1</span> Note</label>
                    <textarea id="current-row-note" class="w-full h-20 bg-secondary border border-primary text-primary rounded px-3 py-2 resize-none" placeholder="Note for current row..."></textarea>
                    <button id="save-row-note" class="mt-2 btn-accent px-3 py-1 rounded text-sm">Save Row Note</button>
                </div>
                
                <!-- Yarn Details -->
                <div class="mb-6">
                    <h4 class="text-md font-medium text-secondary mb-3">Yarn & Materials</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-tertiary mb-1">Yarn Brand & Color</label>
                            <input id="yarn-info" type="text" class="w-full bg-secondary border border-primary text-primary rounded px-2 py-1 text-sm" placeholder="e.g., Red Heart Soft Navy">
                        </div>
                        <div>
                            <label class="block text-xs text-tertiary mb-1">Needle/Hook Size</label>
                            <input id="tool-info" type="text" class="w-full bg-secondary border border-primary text-primary rounded px-2 py-1 text-sm" placeholder="e.g., US 6 (4.0mm)">
                        </div>
                        <div>
                            <label class="block text-xs text-tertiary mb-1">Modifications</label>
                            <textarea id="modifications" class="w-full h-16 bg-secondary border border-primary text-primary rounded px-2 py-1 text-sm resize-none" placeholder="Pattern modifications..."></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Row Notes List -->
                <div class="mb-6">
                    <h4 class="text-md font-medium text-secondary mb-3">All Row Notes</h4>
                    <div id="row-notes-list" class="space-y-2 max-h-40 overflow-y-auto">
                        <!-- Row notes will be populated here -->
                    </div>
                </div>
                
                <button id="save-all-notes" class="w-full btn-success py-2 rounded">Save All Notes</button>
            </div>
        </div>

        <!-- GENERATOR SECTION -->
        <div id="generator-section" class="hidden bg-secondary p-6 sm:p-8 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-primary mb-6 border-b border-primary pb-4">AI Prompt Generator</h2>
            <div class="space-y-8">
                <div>
                    <h3 class="text-lg font-semibold text-secondary mb-3">Step 1: Choose Pattern Format</h3>
                    <div id="pattern-type-selector" class="flex items-center space-x-2 bg-tertiary p-1 rounded-lg max-w-xs">
                        <button data-type="text" class="w-1/2 tab-button active">Text</button>
                        <button data-type="image" class="w-1/2 tab-button">Image</button>
                    </div>
                    <div id="image-instructions" class="hidden mt-4 p-4 bg-warning-muted border border-warning rounded-lg text-warning">
                        <h4 class="font-semibold mb-2">Image-Based Pattern Workflow</h4>
                        <ol class="list-decimal list-inside mt-2 space-y-1 text-sm">
                            <li><strong>Transcribe Image:</strong> Use an AI with vision. Prompt: <span class="mono text-xs bg-tertiary p-1 rounded">"Please transcribe the text from this image of a pattern."</span></li>
                            <li><strong>Generate JSON:</strong> Paste the transcribed text into Step 2 below.</li>
                        </ol>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-secondary mb-3">Step 2: Paste Pattern Text</h3>
                    <textarea id="pattern-input" rows="8" class="w-full p-3 bg-tertiary border border-primary rounded-lg text-secondary focus:ring-2 focus:ring-accent focus:border-accent transition" placeholder="Paste pattern text here..."></textarea>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-secondary mb-3">Step 3: Generate and Copy AI Prompt</h3>
                    <div class="relative">
                        <button id="copy-prompt-button" class="absolute top-3 right-3 btn-secondary font-medium py-1 px-3 border border-primary rounded-md text-sm transition-colors">
                            <span id="copy-default">Copy</span>
                            <span id="copy-success" class="hidden">Copied!</span>
                        </button>
                        <div id="prompt-output" class="code-block h-64 overflow-y-auto">Paste pattern text to generate the prompt.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="fixed bottom-0 left-0 right-0 backdrop-blur-sm border-t p-4 z-50" style="background-color: #1f2937; border-color: #374151;">
        <div id="footer-controls" class="max-w-4xl mx-auto">
            <!-- Pattern Metadata -->
            <div id="pattern-metadata" class="text-center mb-2">
                <div class="text-sm" style="color: #9ca3af;">
                    <span id="current-pattern-name" class="font-medium" style="color: #8b5cf6;">No pattern selected</span>
                    <span class="mx-2">‚Ä¢</span>
                    <span id="pattern-progress-info">Row <span id="footer-current-step">1</span> of <span id="footer-max-steps">1</span></span>
                </div>
            </div>
            
            <div class="relative h-20">
                <div id="step-counter-ui" class="absolute inset-0 flex items-center justify-between transition-opacity duration-300">
                    <!-- Left Side Controls -->
                    <div class="flex items-center space-x-2">
                        <!-- Theme Toggle Button -->
                        <button id="theme-toggle" class="btn-secondary font-bold py-2 px-3 rounded-lg transition-colors flex items-center" title="Toggle light/dark mode">
                            <svg id="theme-icon-dark" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                            </svg>
                            <svg id="theme-icon-light" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="hidden lg:inline text-xs ml-1">Theme</span>
                        </button>
                        
                        <!-- Jump to Start Button -->
                        <button id="jump-to-start" class="btn-accent font-bold py-2 px-3 rounded-lg transition-colors flex items-center" title="Jump to row 1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M15.707 15.707a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 010 1.414zm-6 0a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 011.414 1.414L5.414 10l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="hidden lg:inline text-xs ml-1">Start</span>
                        </button>
                    </div>
                    
                    <!-- Row Counter Section -->
                    <div class="flex items-center space-x-6">
                        <button id="prev-step" class="w-14 h-14 bg-accent text-white font-bold rounded-full text-3xl flex items-center justify-center shadow-lg hover:bg-accent-hover focus:outline-none focus:ring-2 focus:ring-accent focus:ring-opacity-75 transition-transform transform active:scale-95">-</button>
                        <div class="text-center">
                            <div id="step-type" class="text-sm text-tertiary">ROW</div>
                            <input type="number" id="current-step-input" min="1" title="Current step number" aria-label="Current step number" class="text-4xl font-bold text-primary bg-transparent text-center w-28 focus:outline-none focus:ring-2 focus:ring-accent rounded-lg">
                        </div>
                        <button id="next-step" class="w-14 h-14 bg-accent text-white font-bold rounded-full text-3xl flex items-center justify-center shadow-lg hover:bg-accent-hover focus:outline-none focus:ring-2 focus:ring-accent focus:ring-opacity-75 transition-transform transform active:scale-95">+</button>
                    </div>
                    
                    <!-- Right Side Controls -->
                    <div class="flex items-center space-x-2">
                        <!-- Add Note Button -->
                        <button id="add-note" class="btn-warning font-bold py-2 px-3 rounded-lg transition-colors flex items-center" title="Add note for current row">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                            </svg>
                            <span class="hidden lg:inline text-xs ml-1">Note</span>
                        </button>
                        
                        <!-- Notes Toggle Button -->
                        <button id="toggle-notes-sidebar" class="btn-accent font-bold py-2 px-3 rounded-lg transition-colors flex items-center" title="View/Edit Project Notes">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="hidden lg:inline text-xs ml-1">Notes</span>
                        </button>
                    </div>
                </div>
                <div id="stitch-locator-ui" class="absolute inset-0 flex items-center justify-center space-x-4 transition-opacity duration-300 opacity-0 pointer-events-none">
                    <label for="stitch-input" class="text-lg text-primary">Stitch #:</label>
                    <input type="number" id="stitch-input" min="1" class="bg-tertiary text-primary border border-accent rounded-md p-2 w-24 text-center">
                    <button id="find-stitch-btn" class="btn-accent font-bold rounded-md py-2 px-4">Find</button>
                </div>
            </div>
            <div class="text-center mt-2">
                <button id="toggle-mode" class="text-accent hover:text-primary text-sm link-primary">Switch to Stitch Locator</button>
            </div>
        </div>
    </footer>

    <!-- Stitch Definition Modal -->
    <div id="stitch-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-start justify-center p-4 pt-16 z-50 hidden">
        <div class="bg-secondary text-secondary rounded-lg shadow-xl p-6 w-full max-w-md relative modal-content mx-4">
            <button id="close-stitch-modal" class="absolute top-2 right-3 text-tertiary hover:text-primary text-2xl font-bold btn-icon">&times;</button>
            <h3 id="stitch-modal-title" class="text-2xl font-bold mb-4 text-primary"></h3>
            <div id="stitch-modal-definition" class="text-secondary whitespace-pre-line"></div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithRedirect, getRedirectResult, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, addDoc, serverTimestamp, query, where, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Import our modular functions
    import { getInstructionCategory } from "./js/utils.js";
    import { generateGlossary, generateInstructions, generatePatternTheme, updateSidebarColorKey } from "./js/pattern-functions.js";
    import { logStitchWitchQuery, createStitchFinderQuery, createNavigationQuery, getStitchContext } from "./js/stitch-witch.js";
    import { loadProgress, saveProgress, updateDisplay, findInstructionForStep, findStepElement, getStitchCount, loadProgressSimple, loadProgressFirestore, saveProgressFirestore, setupInteractiveFeatures, scrollToCurrentRow, updateCurrentStepDisplay, showStitchDefinition, hideStitchDefinition, setupPatternSidebar, populateSidebarGlossary } from "./js/viewer-logic.js";
    import { saveProjectProgress, getCurrentProject, getOrCreateProject } from "./js/progress-tracking.js";
    import { getCurrentStep, setCurrentStep, loadUserProgress, createNewProject } from "./js/progress-tracking.js";
    import { 
        signInWithGoogle, 
        signOutUser, 
        toggleNotesSidebar,
        loadProjectNotes,
        saveCurrentRowNote,
        addRowNoteIndicator,
        loadRowNoteIndicators,
        goToRowWithNote,
        loadSelectedPattern,
        updateRowNotesList,
        saveAllProjectNotes,
        showSection,
        initThemeToggle,
        checkRedirectResult,
        checkAuthState,
        populateProjectSelector,
        showNewProjectModal,
        toggleArchivedProjects,
        unarchiveProject,
        loadUserProjects,
        loadSelectedProject,
        resetViewer
    } from "./js/app-main.js";
    // Note: createSeaWitchPattern and setupProgressTracking are one-time setup scripts - no longer needed
    
    // --- CONFIG & STATE ---
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
    apiKey: "AIzaSyBmI_9qHr18VWclwzomAUElLTmgJ_MCI3g",
    authDomain: "arachne-edda2.firebaseapp.com",
    projectId: "arachne-edda2",
    storageBucket: "arachne-edda2.firebasestorage.app",
    messagingSenderId: "285468127259",
    appId: "1:285468127259:web:9a1285684a1a6b9b1548be",
    measurementId: "G-208TQKEXGG"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Make db globally available for analytics
    window.db = db;
    window.auth = auth;
    
    let PATTERN_DATA = null;
    let currentStep = 1, maxSteps = 1, progressKey = 'pattern-progress-default';
    let currentPatternId = null;
    let isStitchLocatorMode = false;
    let stitchCountsCache = {};
    let showArchivedProjects = false; // Track whether we're showing archived projects

    // --- UI ELEMENTS ---
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const standaloneGenerator = document.getElementById('standalone-generator');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    // const createSampleProgressBtn = document.getElementById('create-sample-progress-btn');
    // const recreateProgressCollectionBtn = document.getElementById('recreate-progress-collection-btn');
    const backToMainBtn = document.getElementById('back-to-main');
    const userDisplay = document.getElementById('user-display');
    const appNav = document.getElementById('app-nav');
    const viewerSection = document.getElementById('viewer-section');
    const generatorSection = document.getElementById('generator-section');
    const footerControls = document.getElementById('footer-controls');
    const patternSelector = document.getElementById('pattern-selector');
    
    let availablePatterns = [];

    // --- AUTHENTICATION ---
    const provider = new GoogleAuthProvider();
    
    // Force account selection and ensure we get fresh tokens
    provider.setCustomParameters({
        prompt: 'select_account'
    });

    // signInWithGoogle function moved to js/app-main.js
    
    // checkRedirectResult function moved to js/app-main.js
    
    loginBtn.addEventListener('click', signInWithGoogle);
    
    backToMainBtn.addEventListener('click', () => {
        showSection('viewer');
    });
    
    // PROJECT MANAGEMENT EVENT HANDLERS
    const newProjectBtn = document.getElementById('new-project-btn');
    const welcomeNewProjectBtn = document.getElementById('welcome-new-project-btn');
    const deleteProjectBtn = document.getElementById('delete-project-btn');
    const showArchivedBtn = document.getElementById('show-archived-btn');
    const projectSelector = document.getElementById('project-selector');
    
    newProjectBtn.addEventListener('click', showNewProjectModal);
    welcomeNewProjectBtn.addEventListener('click', showNewProjectModal);
    
    if (showArchivedBtn) {
        showArchivedBtn.addEventListener('click', toggleArchivedProjects);
    }
    
    // Project selector change event listener
        projectSelector.addEventListener('change', async (e) => {
            const projectKey = e.target.value;
            if (projectKey) {
                console.log('üéØ Project selected:', projectKey);
                try {
                    const userProjects = await loadUserProjects();
                    await loadSelectedProject(projectKey, userProjects);
                } catch (error) {
                    console.error('‚ùå Error loading selected project:', error);
                    alert('Error loading project: ' + error.message);
                }
            } else {
                // No project selected - reset viewer
                resetViewer();
            }
        });
    
    deleteProjectBtn.addEventListener('click', async () => {
        const selector = document.getElementById('project-selector');
        if (!selector.value) {
            alert('Please select a project to delete.');
            return;
        }
        
        // Check if we're in archived view and this is an unarchive action
        if (showArchivedProjects) {
            // Unarchive the project
            const confirmation = confirm('Restore this project to your active projects list?');
            if (!confirmation) return;
            
            await unarchiveProject(selector.value);
            return;
        }
        
        // Show options for what to do with the project
        const action = confirm('What would you like to do with this project?\n\nOK = Archive (hide from list, keep all data for analytics)\nCancel = Permanently Delete (removes all historical data)');
        
        try {
            const userId = auth.currentUser.uid;
            
            // Get the current project details from our cached userProjects
            const userProjects = await loadUserProjects();
            const selectedProject = userProjects.find(p => `${p.patternId}_${p.projectId}` === selector.value);
            
            if (!selectedProject) {
                console.error('‚ùå Selected project not found in user projects list');
                alert('Error: Selected project not found. Please refresh the page and try again.');
                return;
            }
            
            // Use the actual document ID from the project data
            const progressId = selectedProject.docId || `${userId}_${selectedProject.patternId}_${selectedProject.projectId}`;
            
            console.log('üîÆ Managing project:', { 
                userId, 
                patternId: selectedProject.patternId, 
                projectId: selectedProject.projectId, 
                progressId,
                docId: selectedProject.docId,
                action: action ? 'archive' : 'delete',
                selectorValue: selector.value,
                selectedProject: selectedProject
            });
            
            // Check if document exists before trying to modify
            const docRef = doc(db, 'user_pattern_progress', progressId);
            const docSnapshot = await getDoc(docRef);
            
            if (!docSnapshot.exists()) {
                console.warn('‚ö†Ô∏è Document not found:', progressId);
                console.log('üîç Available projects:', userProjects.map(p => ({ 
                    docId: p.docId, 
                    patternId: p.patternId, 
                    projectId: p.projectId 
                })));
                alert('Project not found. It may have already been deleted.');
                await populateProjectSelector(); // Refresh to show current state
                return;
            }
            
            if (action) {
                // Archive - preserve all data but mark as archived
                console.log('üîí Archiving project:', progressId);
                await updateDoc(docRef, {
                    status: 'archived',
                    archivedAt: serverTimestamp(),
                    archivedReason: 'user_request',
                    lastUpdated: serverTimestamp()
                });
                console.log('‚úÖ Project archived successfully');
                alert('Project archived! All progress data preserved but hidden from active projects.');
            } else {
                // Permanent delete - remove all historical data
                const confirmDelete = confirm('‚ö†Ô∏è PERMANENT DELETE WARNING ‚ö†Ô∏è\n\nThis will permanently remove ALL progress data, notes, photos, and analytics for this project. This cannot be undone.\n\nAre you absolutely sure?');
                if (!confirmDelete) return;
                
                console.log('üóëÔ∏è Permanently deleting project:', progressId);
                await deleteDoc(docRef);
                console.log('‚úÖ Project permanently deleted');
                alert('Project permanently deleted.');
            }
            console.log('‚úÖ All documents deleted successfully');
            
            // Clear current project selection
            window.currentProject = null;
            
            // Refresh project list
            await populateProjectSelector();
            
            console.log('‚úÖ Project deleted and UI refreshed:', projectId);
            alert('Project deleted successfully!');
        } catch (error) {
            console.error('‚ùå Error deleting project:', error);
            console.error('‚ùå Error details:', error.message, error.stack);
            alert(`Error deleting project: ${error.message}`);
        }
    });

    logoutBtn.addEventListener('click', () => {
        signOut(auth).catch(error => console.error("Sign out error", error));
    });

    // DEVELOPMENT BUTTON EVENT HANDLERS - COMMENTED OUT FOR PRODUCTION
    /*
    createSampleProgressBtn.addEventListener('click', async () => {
        try {
            createSampleProgressBtn.disabled = true;
            createSampleProgressBtn.textContent = 'Creating...';
            
            await createSampleUserPatternProgress();
            
            createSampleProgressBtn.textContent = 'Created!';
            createSampleProgressBtn.style.backgroundColor = '#059669'; // green
            
            setTimeout(() => {
                createSampleProgressBtn.disabled = false;
                createSampleProgressBtn.textContent = 'Create Sample Progress';
                createSampleProgressBtn.style.backgroundColor = '#d97706'; // yellow
            }, 2000);
            
        } catch (error) {
            console.error('Error creating sample progress:', error);
            alert('Error creating sample progress: ' + error.message);
            createSampleProgressBtn.disabled = false;
            createSampleProgressBtn.textContent = 'Create Sample Progress';
        }
    });

    recreateProgressCollectionBtn.addEventListener('click', async () => {
        try {
            recreateProgressCollectionBtn.disabled = true;
            recreateProgressCollectionBtn.textContent = 'Recreating...';
            
            await recreateUserPatternProgressCollection();
            
            recreateProgressCollectionBtn.textContent = 'Recreated!';
            recreateProgressCollectionBtn.style.backgroundColor = '#059669'; // green
            
            setTimeout(() => {
                recreateProgressCollectionBtn.disabled = false;
                recreateProgressCollectionBtn.textContent = 'Recreate Progress Collection';
                recreateProgressCollectionBtn.style.backgroundColor = '#7c3aed'; // purple
            }, 2000);
            
        } catch (error) {
            console.error('Error recreating progress collection:', error);
            alert('Error recreating progress collection: ' + error.message);
            recreateProgressCollectionBtn.disabled = false;
            recreateProgressCollectionBtn.textContent = 'Recreate Progress Collection';
        }
    });
    */

    // GLOBAL PATTERN SETUP FUNCTION - moved outside initializeViewer for global access
    window.setupViewer = function() {
        if (!window.PATTERN_DATA) {
            console.error('‚ùå setupViewer called without PATTERN_DATA');
            console.log('‚ùå window.PATTERN_DATA is:', window.PATTERN_DATA);
            return;
        }
        
        console.log('üîß Setting up viewer with pattern:', window.PATTERN_DATA.metadata?.name);
        
        const footerControls = document.getElementById('footer-controls');
        footerControls.classList.remove('hidden');
        const { name, author, maxSteps: max } = window.PATTERN_DATA.metadata;
        
        // Update pattern display elements (now visible in project view)
        const patternNameEl = document.getElementById('pattern-name');
        const patternAuthorEl = document.getElementById('pattern-author');
        
        if (patternNameEl) patternNameEl.textContent = name;
        if (patternAuthorEl) patternAuthorEl.textContent = `by ${author}`;
        
        // Set global variables
        window.maxSteps = max;
        maxSteps = max;
        
        const stepInput = document.getElementById('current-step-input');
        if (stepInput) {
            stepInput.max = maxSteps;
            // Initialize with current project step if available
            if (window.currentProject && window.currentProject.currentStep) {
                currentStep = window.currentProject.currentStep;
                window.currentStep = currentStep;
                stepInput.value = currentStep;
                console.log('üîß Set initial step from project:', currentStep);
            } else {
                // Default to step 1
                currentStep = 1;
                window.currentStep = currentStep;
                stepInput.value = currentStep;
                console.log('üîß Set default step:', currentStep);
            }
        }
        
        progressKey = `pattern-progress-${name.replace(/\s+/g, '-')}`;
        
        // Update footer metadata with actual pattern name immediately
        const currentPatternName = document.getElementById('current-pattern-name');
        if (currentPatternName) {
            currentPatternName.textContent = name;
            console.log('üè∑Ô∏è Footer pattern name updated to:', name);
        }
        
        // Generate pattern content
        const patternContentEl = document.getElementById('pattern-content');
        patternContentEl.innerHTML = '';
        
        // Generate dynamic color theme based on pattern data
        // This replaces hardcoded CSS colors with pattern-specific colors
        generatePatternTheme(window.PATTERN_DATA);
        
        // Make color key function globally available
        window.updateSidebarColorKey = updateSidebarColorKey;
        
        generateGlossary(window.PATTERN_DATA);
        generateInstructions(window.PATTERN_DATA);
        
        // Populate sidebar with pattern-specific content
        populateSidebarGlossary();
        
        // Setup sidebar toggle functionality
        setupPatternSidebar();
        
        // Update footer metadata after content is generated
        updateFooterMetadata();
        
        // Load progress and setup interactions
        const currentStepInput = document.getElementById('current-step-input');
        if (currentStepInput && window.currentProject) {
            currentStepInput.value = window.currentProject.currentStep || 1;
            
            // Add event listener for manual step changes
            currentStepInput.addEventListener('change', (e) => {
                const newStep = parseInt(e.target.value);
                if (newStep >= 1 && newStep <= maxSteps) {
                    currentStep = newStep;
                    window.currentStep = newStep;
                    if (window.currentProject) window.currentProject.currentStep = newStep;
                    
                    // Save to localStorage immediately
                    localStorage.setItem(progressKey, newStep);
                    
                    // Save to Firestore
                    if (typeof saveProjectProgress === 'function' && window.currentProject && auth.currentUser) {
                        saveProjectProgress(db, auth.currentUser.uid, window.currentProject.patternId, window.currentProject.projectId, {
                            currentStep: newStep
                        }).catch(err => console.warn('Failed to save step change:', err));
                    }
                    
                    // Update display
                    if (typeof updateDisplay === 'function') {
                        updateDisplay(newStep, true);
                    }
                    
                    // Update notes label to show current row
                    const noteLabel = document.getElementById('current-row-note-label');
                    if (noteLabel) {
                        noteLabel.textContent = newStep;
                    }
                    
                    console.log('üíæ Step manually changed to:', newStep);
                }
            });
        }
        setupInteractiveFeatures();
        
        // Update notes label to show current row initially
        const noteLabel = document.getElementById('current-row-note-label');
        if (noteLabel) {
            noteLabel.textContent = window.currentProject?.currentStep || currentStep || 1;
        }
        
        console.log('‚úÖ Viewer setup complete for:', name);
        console.log('‚úÖ Current step:', currentStep, 'Max steps:', maxSteps);
    }

    // PROJECT MANAGEMENT FUNCTIONS
    // loadUserProjects function moved to js/app-main.js
    
    // loadFirestorePatterns function moved to js/app-main.js
    
    // populateProjectSelector function moved to js/app-main.js
    
    // loadSelectedProject function moved to js/app-main.js
    
    // loadPatternFromFirestore function moved to js/app-main.js
    
    // resetViewer function moved to js/app-main.js
    
    // NEW PROJECT CREATION FUNCTIONS
    // showNewProjectModal function moved to js/app-main.js
    
    // createNewProjectUI function moved to js/app-main.js
    
    // ARCHIVED PROJECTS FUNCTIONALITY
    // toggleArchivedProjects function moved to js/app-main.js
    
    // unarchiveProject function moved to js/app-main.js

    // --- INITIALIZATION ---
    console.log('Script loaded, initializing app...');
    console.log('Current URL:', window.location.href);
    console.log('URL params:', window.location.search);
    
    // Initialize theme toggle 
    initThemeToggle();
    
    // Check for redirect result first (for mobile compatibility)
    checkRedirectResult();
    
    // Add global error handlers to catch any errors we might miss
    window.addEventListener('error', (event) => {
        console.log('üö® GLOBAL ERROR CAUGHT:', event.error);
        console.log('Error message:', event.message);
        console.log('Error filename:', event.filename);
        console.log('Error line:', event.lineno);
    });
    
    window.addEventListener('unhandledrejection', (event) => {
        console.log('üö® UNHANDLED PROMISE REJECTION:', event.reason);
        console.log('Promise:', event.promise);
    });
    
    // Check if we just came back from a redirect (Google referrer is key indicator)
    const hasGoogleReferrer = document.referrer.includes('accounts.google.com') || 
                             document.referrer.includes('google.com');
    const hasAuthParams = window.location.search.includes('code') || 
                         window.location.search.includes('state') || 
                         window.location.hash.includes('access_token');
    
    console.log('Google referrer detected:', hasGoogleReferrer);
    console.log('Auth URL params detected:', hasAuthParams);
    console.log('Document referrer:', document.referrer);
    
    // If we have any indication we came from Google auth, check immediately
    if (hasGoogleReferrer || hasAuthParams) {
        console.log('üîÑ DETECTED RETURN FROM GOOGLE - checking auth immediately (no delay)');
        checkAuthState();
    } else {
        console.log('üîç Normal page load - checking auth with small delay');
        setTimeout(() => {
            checkAuthState();
        }, 500);
    }

    // --- MAIN APP NAVIGATION ---
    appNav.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const view = e.target.dataset.view;
            appNav.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            
            // Analytics: Track section navigation
            if (auth.currentUser) {
                logStitchWitchQuery({
                    type: 'navigation',
                    action: 'section_switch',
                    section: view,
                    patternId: window.PATTERN_DATA?.id || 'unknown'
                }, db, auth);
            }
            
            if (view === 'viewer') {
                viewerSection.classList.remove('hidden');
                generatorSection.classList.add('hidden');
                footerControls.classList.remove('hidden');
            } else if (view === 'generator') {
                viewerSection.classList.add('hidden');
                generatorSection.classList.remove('hidden');
                footerControls.classList.add('hidden');
            }
        }
    });

    // --- VIEWER LOGIC ---
    // initializeViewer function removed - functionality now distributed across modular js files
    
    // loadSelectedPattern function moved to js/app-main.js

    // --- INTERACTIVE FEATURES SETUP ---
    // setupInteractiveFeatures function moved to js/viewer-logic.js

    // scrollToCurrentRow function moved to js/viewer-logic.js

    // updateDisplay function is imported from viewer-logic.js - no local definition needed

    // highlightCurrentStep function is imported from viewer-logic.js


    // updateCurrentStepDisplay function moved to js/viewer-logic.js
    
    // updateFooterMetadata is defined globally as window.updateFooterMetadata below

    // saveProgress is imported from viewer-logic.js - no local definition needed

    // setupStitchFinder function moved to js/app-main.js
    
    // setupRowNavigation function moved to js/app-main.js
    
    // UPDATE FOOTER METADATA FUNCTION (defined globally as window.updateFooterMetadata below)
    
    // NOTES SIDEBAR FUNCTIONALITY
    // toggleNotesSidebar function moved to js/app-main.js
    
    // loadProjectNotes function moved to js/app-main.js
    
    // updateRowNotesList function moved to js/app-main.js
    
    // goToRowWithNote function is defined in js/app-main.js
    
    // Setup notes sidebar event listeners
    document.addEventListener('DOMContentLoaded', () => {
        const closeNotesBtn = document.getElementById('close-notes-sidebar');
        const saveRowNoteBtn = document.getElementById('save-row-note');
        const saveAllNotesBtn = document.getElementById('save-all-notes');
        
        if (closeNotesBtn) {
            closeNotesBtn.addEventListener('click', () => {
                const sidebar = document.getElementById('notes-sidebar');
                sidebar.classList.add('translate-x-full');
            });
        }
        
        if (saveRowNoteBtn) {
            saveRowNoteBtn.addEventListener('click', async () => {
                await saveCurrentRowNote();
            });
        }
        
        if (saveAllNotesBtn) {
            saveAllNotesBtn.addEventListener('click', async () => {
                await saveAllProjectNotes();
            });
        }
    });
    
    // saveCurrentRowNote function moved to js/app-main.js
    
    // saveAllProjectNotes function moved to js/app-main.js
    
    // addRowNoteIndicator function is defined in js/app-main.js
    
    // loadRowNoteIndicators function is defined in js/app-main.js
    
    // highlightCurrentStep function is imported from viewer-logic.js
        
        // Setup Jump to Start button
        const jumpToStartBtn = document.getElementById('jump-to-start');
        if (jumpToStartBtn && !jumpToStartBtn.hasAttribute('data-listener-added')) {
            jumpToStartBtn.setAttribute('data-listener-added', 'true');
            jumpToStartBtn.addEventListener('click', () => {
                currentStep = 1;
                stepInput.value = 1;
                // Save immediately to localStorage for instant response
                localStorage.setItem(progressKey, currentStep);
                if (window.currentProject) window.currentProject.currentStep = currentStep;
                
                // Save to Firestore in background (non-blocking)
                if (typeof saveProjectProgress === 'function' && window.currentProject && auth.currentUser) {
                    saveProjectProgress(db, auth.currentUser.uid, window.currentProject.patternId, window.currentProject.projectId, {
                        currentStep: currentStep
                    }).catch(err => console.warn('Background save failed:', err));
                }
                updateDisplay(currentStep, true);
            });
        }
        
        // Setup Add Note button  
        const addNoteBtn = document.getElementById('add-note');
        if (addNoteBtn && !addNoteBtn.hasAttribute('data-listener-added')) {
            addNoteBtn.setAttribute('data-listener-added', 'true');
            addNoteBtn.addEventListener('click', () => {
                const note = prompt(`Add a note for row ${currentStep}:`);
                if (note && note.trim()) {
                    console.log('üìù Adding note for row', currentStep, ':', note.trim());
                    // Store note in localStorage for now
                    const notes = JSON.parse(localStorage.getItem('pattern-notes') || '{}');
                    const patternKey = window.PATTERN_DATA?.metadata?.title || 'unknown-pattern';
                    if (!notes[patternKey]) notes[patternKey] = {};
                    notes[patternKey][currentStep] = note.trim();
                    localStorage.setItem('pattern-notes', JSON.stringify(notes));
                    
                    // Show confirmation
                    const originalText = addNoteBtn.innerHTML;
                    addNoteBtn.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg><span class="hidden lg:inline text-xs ml-1">Saved!</span>';
                    setTimeout(() => {
                        addNoteBtn.innerHTML = originalText;
                    }, 2000);
                }
            });
        }
        
        // Keyboard navigation - avoid calling button.click() to prevent double triggers
        if (!window.keyboardNavSetup) {
            window.keyboardNavSetup = true;
            document.addEventListener('keydown', (e) => {
                // Get stepInput reference each time to ensure it exists
                const stepInput = document.getElementById('current-step-input');
                
                // Skip if user is typing in an input field
                if (document.activeElement === stepInput || document.activeElement.tagName === 'INPUT') {
                    return;
                }
                
                if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (currentStep < maxSteps) {
                        currentStep++;
                        if (stepInput) stepInput.value = currentStep;
                        // Save immediately to localStorage for instant response
                        localStorage.setItem(progressKey, currentStep);
                        if (window.currentProject) window.currentProject.currentStep = currentStep;
                        
                        // Save to Firestore in background (non-blocking)
                        if (typeof saveProjectProgress === 'function' && window.currentProject && auth.currentUser) {
                            saveProjectProgress(db, auth.currentUser.uid, window.currentProject.patternId, window.currentProject.projectId, {
                                currentStep: currentStep
                            }).catch(err => console.warn('Background save failed:', err));
                        }
                        updateDisplay(currentStep, true);
                        
                        // Update notes label to show current row
                        const noteLabel = document.getElementById('current-row-note-label');
                        if (noteLabel) {
                            noteLabel.textContent = currentStep;
                        }
                    }
                }
                
                if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (currentStep > 1) {
                        currentStep--;
                        if (stepInput) stepInput.value = currentStep;
                        // Save immediately to localStorage for instant response
                        localStorage.setItem(progressKey, currentStep);
                        if (window.currentProject) window.currentProject.currentStep = currentStep;
                        
                        // Save to Firestore in background (non-blocking)
                        if (typeof saveProjectProgress === 'function' && window.currentProject && auth.currentUser) {
                            saveProjectProgress(db, auth.currentUser.uid, window.currentProject.patternId, window.currentProject.projectId, {
                                currentStep: currentStep
                            }).catch(err => console.warn('Background save failed:', err));
                        }
                        updateDisplay(currentStep, true);
                        
                        // Update notes label to show current row
                        const noteLabel = document.getElementById('current-row-note-label');
                        if (noteLabel) {
                            noteLabel.textContent = currentStep;
                        }
                    }
                }
            });
        }
    

    // Footer update function is handled by viewer-logic.js

    // --- STITCH MODAL FUNCTIONALITY ---
    const stitchModal = document.getElementById('stitch-modal');
    const stitchModalTitle = document.getElementById('stitch-modal-title');
    const stitchModalDefinition = document.getElementById('stitch-modal-definition');
    const closeStitchModal = document.getElementById('close-stitch-modal');
    
    // showStitchDefinition function moved to js/viewer-logic.js
    
    // hideStitchDefinition function moved to js/viewer-logic.js
    
    // Event listeners for stitch interactions
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('stitch-clickable')) {
            e.preventDefault();
            const stitchCode = e.target.dataset.stitch || e.target.textContent.trim();
            showStitchDefinition(stitchCode);
        }
    });
    
    // --- PATTERN TOOLS SIDEBAR FUNCTIONALITY ---
    // setupPatternSidebar function migrated to js/viewer-logic.js
    
    // populateSidebarGlossary function migrated to js/viewer-logic.js
    
    closeStitchModal.addEventListener('click', hideStitchDefinition);
    stitchModal.addEventListener('click', (e) => {
        if (e.target === stitchModal) {
            hideStitchDefinition();
        }
    });
    
    // --- SECTION MANAGEMENT ---
    // showSection function moved to js/app-main.js
    
    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !stitchModal.classList.contains('hidden')) {
            hideStitchDefinition();
        }
    });

    // --- PWA Service Worker ---
    // Temporarily disabled to fix caching issues during development
    // if('serviceWorker' in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('/sw.js').then(reg=>console.log('SW registered.')).catch(err=>console.log('SW registration failed: ',err));});}

    // Script initialization complete
</script>
</body>
</html>