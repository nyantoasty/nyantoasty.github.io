<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Pattern - Stitch Witch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1f2937">
    <style>
        .tab-button { padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
        .tab-button.active { background-color: #8b5cf6; color: white; }
        .tab-button:not(.active):hover { background-color: #4a5568; }
        .tab-content.hidden {
            display: none;
        }
        .generating {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header matching the main Pattern Hub -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 border-b border-gray-700 pb-4">
            <div class="text-center sm:text-left mb-4 sm:mb-0">
                <h1 class="text-3xl font-bold text-white">Pattern Hub</h1>
                <p class="text-sm text-gray-400">AI Pattern Generator</p>
                <p class="text-xs text-gray-500">v2025-10-02 - Upload & Convert Patterns</p>
            </div>
            <div class="flex items-center space-x-4">
                <nav class="flex items-center space-x-2 bg-gray-800 p-1 rounded-lg">
                    <a href="/" class="tab-button">Viewer</a>
                    <span class="bg-green-600 text-white font-medium py-2 px-4 rounded-lg text-sm">Generator</span>
                </nav>
            </div>
        </header>

        <!-- Generator Section Header -->
        <div class="text-center mb-8">
            <h2 class="text-4xl font-bold text-transparent bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text mb-4">
                <i class="fas fa-magic"></i> AI Pattern Generator
            </h2>
            <p class="text-gray-300">Upload files or enter text to convert patterns using AI</p>
        </div>

        <!-- Upload Steps -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-4">
                    <div id="step1" class="flex items-center space-x-2">
                        <div class="w-8 h-8 rounded-full bg-purple-600 text-white flex items-center justify-center text-sm font-bold">1</div>
                        <span>Paste JSON</span>
                    </div>
                    <div class="w-8 h-1 bg-gray-600" id="progress1"></div>
                    <div id="step2" class="flex items-center space-x-2 text-gray-500">
                        <div class="w-8 h-8 rounded-full bg-gray-600 text-white flex items-center justify-center text-sm font-bold">2</div>
                        <span>Preview</span>
                    </div>
                    <div class="w-8 h-1 bg-gray-600" id="progress2"></div>
                    <div id="step3" class="flex items-center space-x-2 text-gray-500">
                        <div class="w-8 h-8 rounded-full bg-gray-600 text-white flex items-center justify-center text-sm font-bold">3</div>
                        <span>Upload</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 1: Pattern Input -->
        <div id="pattern-input-section" class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-2xl font-semibold mb-4"><i class="fas fa-code"></i> Step 1: Pattern Input</h2>
            
            <!-- Input Method Tabs -->
            <div class="flex mb-6 border-b border-gray-600">
                <button id="manual-tab" class="tab-button active px-6 py-3 font-semibold border-b-2 border-purple-500 text-purple-400">
                    <i class="fas fa-code mr-2"></i>Manual JSON
                </button>
                <button id="ai-tab" class="tab-button px-6 py-3 font-semibold border-b-2 border-transparent text-gray-400 hover:text-gray-300">
                    <i class="fas fa-magic mr-2"></i>AI Convert Pattern
                </button>
            </div>

            <!-- Manual JSON Input -->
            <div id="manual-input" class="tab-content">
                <div class="mb-4">
                    <textarea 
                        id="pattern-json" 
                        class="w-full h-96 p-4 bg-gray-700 border border-gray-600 rounded-lg text-white font-mono text-sm resize-vertical focus:ring-2 focus:ring-purple-500 focus:border-purple-500" 
                        placeholder='Paste your pattern JSON here. Example:
{
  "metadata": {
    "name": "My Pattern",
    "author": "Your Name",
    "craft": "knitting",
    "maxSteps": 10
  },
  "glossary": {
    "k": {
      "name": "Knit",
      "description": "Knit stitch.",
      "stitchesUsed": 1,
      "stitchesCreated": 1
    }
  },
  "steps": [...]
}'></textarea>
                </div>

                <div id="validation-results" class="mb-4"></div>

                <div class="flex space-x-4">
                    <button id="validate-json" class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-check-circle"></i> Validate JSON
                    </button>
                    <button id="load-example" class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-file-code"></i> Load Example
                    </button>
                </div>
            </div>

            <!-- AI Pattern Conversion -->
            <div id="ai-input" class="tab-content hidden">
                <!-- File Upload Section -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-3 text-gray-300">
                        <i class="fas fa-upload mr-2"></i>Upload Pattern Files
                    </h4>
                    <div class="border-2 border-dashed border-gray-600 rounded-lg p-6 hover:border-purple-500 transition-colors">
                        <div class="text-center">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-300 mb-2">Drop files here or click to upload</p>
                            <p class="text-gray-500 text-sm mb-4">Supports: PDF, Images (JPG, PNG), Text files</p>
                            <input 
                                type="file" 
                                id="pattern-file-input" 
                                class="hidden"
                                accept=".pdf,.jpg,.jpeg,.png,.txt,.doc,.docx"
                                multiple>
                            <button 
                                type="button"
                                onclick="document.getElementById('pattern-file-input').click()"
                                class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-lg font-semibold transition-colors">
                                <i class="fas fa-folder-open mr-2"></i>Choose Files
                            </button>
                        </div>
                    </div>
                    
                    <!-- File Preview Area -->
                    <div id="file-preview-area" class="mt-4 hidden">
                        <h5 class="font-semibold text-gray-300 mb-2">Uploaded Files:</h5>
                        <div id="file-preview-list" class="space-y-2">
                            <!-- File previews will be added here -->
                        </div>
                    </div>
                    
                    <!-- OCR Processing Status -->
                    <div id="ocr-status" class="mt-4 hidden">
                        <!-- OCR status will be shown here -->
                    </div>
                </div>

                <!-- Text Input (Alternative) -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <label for="pattern-text" class="block text-sm font-medium text-gray-300">
                            <i class="fas fa-file-text mr-1"></i> Or paste your pattern text directly:
                        </label>
                        <span class="text-xs text-gray-500">Text input • Alternative to file upload</span>
                    </div>
                    <textarea 
                        id="pattern-text" 
                        class="w-full h-48 p-4 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm resize-vertical focus:ring-2 focus:ring-purple-500 focus:border-purple-500" 
                        placeholder="Paste your knitting pattern here. For example:

Cast on 42 sts.
Row 1 (WS): K to end.
Row 2 (RS): K2, *yo, k to 1 st before m, yo, k1, slm, k1; repeat from * three times, yo, k to last 2 sts, yo, k2.
Row 3 (WS): K2, p to last 2 sts, k2.
Repeat rows 2-3 until...

The AI will convert this into structured JSON following our pattern format."></textarea>
                </div>

                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-3 text-gray-300">Pattern Details (Optional)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="ai-pattern-name" class="block text-sm font-medium text-gray-400 mb-1">Pattern Name</label>
                            <input 
                                type="text" 
                                id="ai-pattern-name" 
                                class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                placeholder="My Beautiful Shawl">
                        </div>
                        <div>
                            <label for="ai-pattern-author" class="block text-sm font-medium text-gray-400 mb-1">Designer Name</label>
                            <input 
                                type="text" 
                                id="ai-pattern-author" 
                                class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                placeholder="Jane Designer">
                        </div>
                    </div>
                </div>

                <div id="ai-conversion-results" class="mb-4"></div>

                <div class="flex space-x-4">
                    <button id="generate-pattern" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 px-6 py-2 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-magic"></i> Generate JSON Pattern
                    </button>
                    <button id="clear-ai-input" class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>

                <div class="mt-4 p-4 bg-blue-900 border border-blue-500 rounded-lg">
                    <h5 class="font-semibold text-blue-200 mb-2"><i class="fas fa-info-circle"></i> How it works:</h5>
                    <ul class="text-blue-300 text-sm space-y-1">
                        <li>• <strong>File Upload:</strong> OCR extracts text from PDFs, images, and documents</li>
                        <li>• <strong>AI Conversion:</strong> Uses our comprehensive logic guide to parse patterns</li>
                        <li>• <strong>Smart Processing:</strong> Calculates stitch counts and enumerates all repeats</li>
                        <li>• <strong>JSON Generation:</strong> Creates proper structure with glossary and metadata</li>
                        <li>• <strong>Review & Edit:</strong> You can modify the generated JSON before uploading</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Step 2: Pattern Preview -->
        <div id="preview-section" class="bg-gray-800 rounded-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-semibold mb-4"><i class="fas fa-eye"></i> Step 2: Preview Your Pattern</h2>
            
            <div id="pattern-preview-content">
                <!-- Preview content will be populated here -->
            </div>

            <div class="flex space-x-4 mt-6">
                <button id="proceed-upload" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-semibold transition-colors">
                    <i class="fas fa-upload"></i> Upload Pattern
                </button>
                <button id="back-to-json" class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold transition-colors">
                    <i class="fas fa-arrow-left"></i> Back to Edit
                </button>
            </div>
        </div>

        <!-- Step 3: Upload Status -->
        <div id="upload-section" class="bg-gray-800 rounded-lg p-6 mb-6 hidden">
            <h2 class="text-2xl font-semibold mb-4"><i class="fas fa-cloud-upload-alt"></i> Step 3: Upload to Firestore</h2>
            
            <div id="upload-status" class="mb-4">
                <!-- Upload status will be shown here -->
            </div>

            <div id="upload-actions" class="flex space-x-4 hidden">
                <button id="confirm-upload" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-semibold transition-colors">
                    <i class="fas fa-check"></i> Keep Pattern
                </button>
                <button id="cancel-upload" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-semibold transition-colors">
                    <i class="fas fa-trash"></i> Delete Pattern
                </button>
                <a id="view-pattern" href="#" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold transition-colors inline-block">
                    <i class="fas fa-external-link-alt"></i> View Pattern
                </a>
            </div>
        </div>

        <!-- Authentication Status -->
        <div id="auth-status" class="bg-gray-800 rounded-lg p-6 mb-6">
            <h3 class="text-lg font-semibold mb-2">Authentication Status</h3>
            <div id="auth-info" class="text-gray-400">Checking authentication...</div>
            <button id="sign-in-btn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded mt-2 hidden">Sign In</button>
        </div>
    </div>

    <!-- Firebase and App Scripts -->
    <script type="module">
        import { auth, db, app } from './js/firebase-config.js';
        import { initializeOCRIntegration } from './js/pattern-ocr-integration.js';
        import { 
            signInWithPopup, 
            GoogleAuthProvider, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            doc, 
            collection,
            addDoc,
            setDoc, 
            deleteDoc, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables
        let currentUser = null;
        let uploadedPatternId = null;
        let validatedPattern = null;

        // DOM elements
        const jsonTextarea = document.getElementById('pattern-json');
        const validateBtn = document.getElementById('validate-json');
        const loadExampleBtn = document.getElementById('load-example');
        const validationResults = document.getElementById('validation-results');
        
        // Tab elements
        const manualTab = document.getElementById('manual-tab');
        const aiTab = document.getElementById('ai-tab');
        const manualInput = document.getElementById('manual-input');
        const aiInput = document.getElementById('ai-input');
        
        // AI elements
        const patternTextarea = document.getElementById('pattern-text');
        const aiPatternName = document.getElementById('ai-pattern-name');
        const aiPatternAuthor = document.getElementById('ai-pattern-author');
        const generateBtn = document.getElementById('generate-pattern');
        const clearAiBtn = document.getElementById('clear-ai-input');
        const aiResults = document.getElementById('ai-conversion-results');
        
        // File upload elements
        const fileInput = document.getElementById('pattern-file-input');
        const filePreviewArea = document.getElementById('file-preview-area');
        const filePreviewList = document.getElementById('file-preview-list');
        const ocrStatus = document.getElementById('ocr-status');
        
        let uploadedFiles = [];
        let extractedText = '';
        
        const previewSection = document.getElementById('preview-section');
        const previewContent = document.getElementById('pattern-preview-content');
        const proceedBtn = document.getElementById('proceed-upload');
        const backBtn = document.getElementById('back-to-json');
        
        const uploadSection = document.getElementById('upload-section');
        const uploadStatus = document.getElementById('upload-status');
        const uploadActions = document.getElementById('upload-actions');
        const confirmBtn = document.getElementById('confirm-upload');
        const cancelBtn = document.getElementById('cancel-upload');
        const viewBtn = document.getElementById('view-pattern');

        const authInfo = document.getElementById('auth-info');
        const signInBtn = document.getElementById('sign-in-btn');

        // Tab switching functionality
        function switchTab(activeTab, inactiveTab, activeContent, inactiveContent) {
            activeTab.classList.add('active', 'text-purple-400', 'border-purple-500');
            activeTab.classList.remove('text-gray-400', 'border-transparent');
            
            inactiveTab.classList.remove('active', 'text-purple-400', 'border-purple-500');
            inactiveTab.classList.add('text-gray-400', 'border-transparent');
            
            activeContent.classList.remove('hidden');
            inactiveContent.classList.add('hidden');
        }

        manualTab.addEventListener('click', () => {
            switchTab(manualTab, aiTab, manualInput, aiInput);
        });

        aiTab.addEventListener('click', () => {
            switchTab(aiTab, manualTab, aiInput, manualInput);
        });

        // AI Pattern Generation
        async function generatePatternFromText() {
            // Get text from either file upload or direct input
            const patternText = extractedText || patternTextarea.value.trim();
            
            if (!patternText) {
                showAiError('Please upload pattern files or paste pattern text first');
                return;
            }

            if (!currentUser) {
                showAiError('Please sign in first to use AI pattern generation');
                return;
            }

            try {
                generateBtn.disabled = true;
                generateBtn.classList.add('generating');
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                
                showAiStatus('Converting your pattern to JSON...', 'blue');

                // Import Firebase Functions
                const { getFunctions, httpsCallable } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js");
                const functions = getFunctions(app, 'us-central1'); // Explicitly set region
                
                const generatePattern = httpsCallable(functions, 'generatePattern');
                
                // Call the Firebase Function
                const result = await generatePattern({
                    patternText: patternText,
                    patternName: aiPatternName.value || null,
                    patternAuthor: aiPatternAuthor.value || null
                });
                
                if (result.data.success) {
                    // Populate the manual JSON textarea with generated content
                    jsonTextarea.value = result.data.generatedJson;
                    
                    // Switch to manual tab to show result
                    switchTab(manualTab, aiTab, manualInput, aiInput);
                    
                    const sourceInfo = extractedText ? 
                        `Generated from ${uploadedFiles.length} uploaded file(s)` : 
                        'Generated from pasted text';
                    
                    showAiStatus(`✅ Pattern generated successfully! ${sourceInfo}. Review the JSON in the Manual tab.`, 'green');
                    
                    // Auto-validate the generated JSON
                    setTimeout(() => {
                        validateBtn.click();
                    }, 500);
                    
                } else {
                    showAiError('Failed to generate pattern. Please try again.');
                }

            } catch (error) {
                console.error('AI Generation error:', error);
                
                if (error.code === 'functions/unauthenticated') {
                    showAiError('Please sign in to use AI pattern generation.');
                } else if (error.code === 'functions/resource-exhausted') {
                    showAiError('Daily AI generation limit reached. Try again tomorrow.');
                } else if (error.code === 'functions/invalid-argument') {
                    showAiError('Pattern text is too short. Please provide more details.');
                } else {
                    showAiError('Failed to generate pattern. Please try again or use manual input.');
                }
            } finally {
                generateBtn.disabled = false;
                generateBtn.classList.remove('generating');
                generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generate JSON Pattern';
            }
        }

        function showAiStatus(message, type = 'blue') {
            const bgColor = type === 'green' ? 'bg-green-900 border-green-500' : 
                           type === 'red' ? 'bg-red-900 border-red-500' : 
                           'bg-blue-900 border-blue-500';
            const textColor = type === 'green' ? 'text-green-300' : 
                            type === 'red' ? 'text-red-300' : 
                            'text-blue-300';
            
            aiResults.innerHTML = `
                <div class="${bgColor} border rounded p-4 mb-4">
                    <p class="${textColor}">${message}</p>
                </div>
            `;
        }

        function showAiError(message) {
            showAiStatus(`❌ ${message}`, 'red');
        }

        // File Upload and OCR Functions
        function handleFileUpload(files) {
            uploadedFiles = Array.from(files);
            displayFilePreview();
            processFilesWithOCR();
        }

        function displayFilePreview() {
            if (uploadedFiles.length === 0) {
                filePreviewArea.classList.add('hidden');
                return;
            }

            filePreviewArea.classList.remove('hidden');
            filePreviewList.innerHTML = '';

            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between p-3 bg-gray-700 rounded border';
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'flex items-center space-x-3';
                
                const fileIcon = getFileIcon(file.type);
                const fileName = file.name.length > 30 ? file.name.substring(0, 30) + '...' : file.name;
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                
                fileInfo.innerHTML = `
                    <i class="${fileIcon} text-purple-400"></i>
                    <div>
                        <p class="text-white font-medium">${fileName}</p>
                        <p class="text-gray-400 text-sm">${fileSize} MB • ${file.type || 'Unknown type'}</p>
                    </div>
                `;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'text-red-400 hover:text-red-300 p-1';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.onclick = () => removeFile(index);
                
                fileItem.appendChild(fileInfo);
                fileItem.appendChild(removeBtn);
                filePreviewList.appendChild(fileItem);
            });
        }

        function getFileIcon(mimeType) {
            if (mimeType?.includes('pdf')) return 'fas fa-file-pdf';
            if (mimeType?.includes('image')) return 'fas fa-file-image';
            if (mimeType?.includes('text')) return 'fas fa-file-text';
            if (mimeType?.includes('word')) return 'fas fa-file-word';
            return 'fas fa-file';
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            displayFilePreview();
            if (uploadedFiles.length === 0) {
                extractedText = '';
                patternTextarea.value = '';
                ocrStatus.classList.add('hidden');
            }
        }

        async function processFilesWithOCR() {
            if (uploadedFiles.length === 0) return;

            try {
                ocrStatus.classList.remove('hidden');
                ocrStatus.innerHTML = `
                    <div class="bg-blue-900 border border-blue-500 rounded p-4">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-spinner fa-spin text-blue-400"></i>
                            <span class="text-blue-300">Processing files with OCR...</span>
                        </div>
                        <div class="mt-2 text-blue-400 text-sm">${uploadedFiles.length} file(s) to process</div>
                    </div>
                `;

                console.log('🔧 Starting OCR processing...');
                console.log('🔐 Current user:', currentUser);

                let allExtractedText = '';

                for (let i = 0; i < uploadedFiles.length; i++) {
                    const file = uploadedFiles[i];
                    
                    ocrStatus.innerHTML = `
                        <div class="bg-blue-900 border border-blue-500 rounded p-4">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-spinner fa-spin text-blue-400"></i>
                                <span class="text-blue-300">Processing ${file.name}...</span>
                            </div>
                            <div class="mt-2 text-blue-400 text-sm">File ${i + 1} of ${uploadedFiles.length}</div>
                        </div>
                    `;

                    // Convert file to base64
                    const base64 = await fileToBase64(file);
                    
                    console.log(`🔍 Calling processOCR for ${file.name}`);
                    
                    // Call OCR function using direct HTTP request
                    const response = await fetch('https://us-central1-arachne-edda2.cloudfunctions.net/processOCR', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            data: {
                                fileData: base64,
                                fileName: file.name,
                                mimeType: file.type
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('✅ OCR result:', result);

                    if (result.success) {
                        allExtractedText += `\n--- From ${file.name} ---\n${result.text}\n`;
                    }
                }

                extractedText = allExtractedText.trim();
                patternTextarea.value = extractedText;

                ocrStatus.innerHTML = `
                    <div class="bg-green-900 border border-green-500 rounded p-4">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-check-circle text-green-400"></i>
                            <span class="text-green-300">OCR processing complete!</span>
                        </div>
                        <div class="mt-2 text-green-400 text-sm">${extractedText.length} characters extracted</div>
                    </div>
                `;

            } catch (error) {
                console.error('OCR processing error:', error);
                ocrStatus.innerHTML = `
                    <div class="bg-red-900 border border-red-500 rounded p-4">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-exclamation-triangle text-red-400"></i>
                            <span class="text-red-300">OCR processing failed</span>
                        </div>
                        <div class="mt-2 text-red-400 text-sm">${error.message}</div>
                    </div>
                `;
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        // Drag and drop functionality
        function setupDragAndDrop() {
            const dropZone = document.querySelector('.border-dashed');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });

            dropZone.addEventListener('drop', handleDrop, false);

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight(e) {
                dropZone.classList.add('border-purple-500', 'bg-purple-900', 'bg-opacity-20');
            }

            function unhighlight(e) {
                dropZone.classList.remove('border-purple-500', 'bg-purple-900', 'bg-opacity-20');
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFileUpload(files);
            }
        }

        // Event listeners for AI functionality
        generateBtn.addEventListener('click', generatePatternFromText);
        
        // File upload event listeners
        fileInput.addEventListener('change', (e) => {
            handleFileUpload(e.target.files);
        });
        
        clearAiBtn.addEventListener('click', () => {
            patternTextarea.value = '';
            aiPatternName.value = '';
            aiPatternAuthor.value = '';
            aiResults.innerHTML = '';
            
            // Clear file uploads
            uploadedFiles = [];
            extractedText = '';
            fileInput.value = '';
            filePreviewArea.classList.add('hidden');
            ocrStatus.classList.add('hidden');
        });

        // Initialize drag and drop
        setupDragAndDrop();
        
        // Initialize OCR integration
        initializeOCRIntegration();

        // Authentication
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                authInfo.textContent = `Signed in as ${user.displayName || user.email}`;
                signInBtn.classList.add('hidden');
            } else {
                authInfo.textContent = 'Please sign in to upload patterns';
                signInBtn.classList.remove('hidden');
            }
        });

        signInBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Sign in error:', error);
                showError('Failed to sign in: ' + error.message);
            }
        });

        // Example pattern for testing
        const examplePattern = {
            metadata: {
                name: "Simple Dishcloth",
                author: "Example Author",
                craft: "knitting",
                maxSteps: 6
            },
            glossary: {
                k: {
                    name: "Knit",
                    description: "Knit stitch.",
                    stitchesUsed: 1,
                    stitchesCreated: 1
                },
                p: {
                    name: "Purl", 
                    description: "Purl stitch.",
                    stitchesUsed: 1,
                    stitchesCreated: 1
                }
            },
            steps: [
                {
                    step: 0,
                    description: "Cast on 20 stitches.",
                    section: "setup",
                    type: "specialInstruction"
                },
                {
                    step: 1,
                    startingStitchCount: 20,
                    endingStitchCount: 20,
                    instruction: "k20",
                    section: "body",
                    side: "RS",
                    type: "regular"
                },
                {
                    step: 2,
                    startingStitchCount: 20,
                    endingStitchCount: 20,
                    instruction: "p20",
                    section: "body",
                    side: "WS",
                    type: "regular"
                }
            ]
        };

        // Load example pattern
        loadExampleBtn.addEventListener('click', () => {
            jsonTextarea.value = JSON.stringify(examplePattern, null, 2);
        });

        // Validation function
        function validatePattern(jsonText) {
            const errors = [];
            const warnings = [];
            
            try {
                const pattern = JSON.parse(jsonText);
                
                // Required top-level properties
                if (!pattern.metadata) errors.push('Missing required "metadata" object');
                if (!pattern.glossary) errors.push('Missing required "glossary" object');
                if (!pattern.steps) errors.push('Missing required "steps" array');
                
                // Metadata validation
                if (pattern.metadata) {
                    if (!pattern.metadata.name) errors.push('metadata.name is required');
                    if (!pattern.metadata.author) errors.push('metadata.author is required');
                    if (!pattern.metadata.craft) errors.push('metadata.craft is required');
                    if (!pattern.metadata.maxSteps) errors.push('metadata.maxSteps is required');
                }
                
                // Glossary validation
                if (pattern.glossary) {
                    for (const [key, stitch] of Object.entries(pattern.glossary)) {
                        if (!stitch.name) errors.push(`glossary.${key}.name is required`);
                        if (!stitch.description) errors.push(`glossary.${key}.description is required`);
                        if (stitch.stitchesUsed === undefined) errors.push(`glossary.${key}.stitchesUsed is required`);
                        if (stitch.stitchesCreated === undefined) errors.push(`glossary.${key}.stitchesCreated is required`);
                        
                        // Check for old schema
                        if (stitch.stitchIndex !== undefined) {
                            warnings.push(`glossary.${key} uses deprecated "stitchIndex". Use "stitchesUsed" and "stitchesCreated"`);
                        }
                    }
                }
                
                // Steps validation
                if (pattern.steps && Array.isArray(pattern.steps)) {
                    pattern.steps.forEach((step, index) => {
                        if (step.step === undefined) errors.push(`steps[${index}].step is required`);
                        if (!step.type) errors.push(`steps[${index}].type is required`);
                        
                        if (step.type === 'regular') {
                            if (!step.instruction) errors.push(`steps[${index}].instruction is required for regular steps`);
                        } else if (step.type === 'specialInstruction') {
                            if (!step.description) errors.push(`steps[${index}].description is required for special instructions`);
                        }
                    });
                } else {
                    errors.push('steps must be an array');
                }
                
                return { pattern, errors, warnings };
                
            } catch (e) {
                errors.push('Invalid JSON: ' + e.message);
                return { pattern: null, errors, warnings };
            }
        }

        // Show validation results
        function showValidationResults(errors, warnings) {
            let html = '';
            
            if (errors.length > 0) {
                html += '<div class="bg-red-900 border border-red-500 rounded p-4 mb-4">';
                html += '<h4 class="font-semibold text-red-200 mb-2"><i class="fas fa-exclamation-triangle"></i> Errors</h4>';
                html += '<ul class="text-red-300 text-sm space-y-1">';
                errors.forEach(error => {
                    html += `<li>• ${error}</li>`;
                });
                html += '</ul></div>';
            }
            
            if (warnings.length > 0) {
                html += '<div class="bg-yellow-900 border border-yellow-500 rounded p-4 mb-4">';
                html += '<h4 class="font-semibold text-yellow-200 mb-2"><i class="fas fa-exclamation-circle"></i> Warnings</h4>';
                html += '<ul class="text-yellow-300 text-sm space-y-1">';
                warnings.forEach(warning => {
                    html += `<li>• ${warning}</li>`;
                });
                html += '</ul></div>';
            }
            
            if (errors.length === 0 && warnings.length === 0) {
                html += '<div class="bg-green-900 border border-green-500 rounded p-4 mb-4">';
                html += '<h4 class="font-semibold text-green-200"><i class="fas fa-check-circle"></i> Pattern is valid!</h4>';
                html += '</div>';
            }
            
            validationResults.innerHTML = html;
        }

        // Generate pattern preview
        function generatePreview(pattern) {
            let html = `
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-purple-300">Pattern Details</h3>
                        <div class="bg-gray-700 rounded p-4 space-y-2">
                            <p><strong>Name:</strong> ${pattern.metadata.name}</p>
                            <p><strong>Author:</strong> ${pattern.metadata.author}</p>
                            <p><strong>Craft:</strong> ${pattern.metadata.craft}</p>
                            <p><strong>Total Steps:</strong> ${pattern.metadata.maxSteps}</p>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-purple-300">Stitch Glossary</h3>
                        <div class="bg-gray-700 rounded p-4 max-h-64 overflow-y-auto">
            `;
            
            for (const [key, stitch] of Object.entries(pattern.glossary)) {
                html += `
                    <div class="mb-2 pb-2 border-b border-gray-600 last:border-b-0">
                        <div class="font-semibold text-violet-300">${stitch.name} (${key})</div>
                        <div class="text-sm text-gray-400">${stitch.description}</div>
                        <div class="text-xs text-gray-500">Uses: ${stitch.stitchesUsed}, Creates: ${stitch.stitchesCreated}</div>
                    </div>
                `;
            }
            
            html += `
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h3 class="text-xl font-semibold mb-3 text-purple-300">First 5 Steps</h3>
                    <div class="bg-gray-700 rounded p-4 space-y-3">
            `;
            
            const firstSteps = pattern.steps.slice(0, 5);
            firstSteps.forEach(step => {
                html += `
                    <div class="border-l-4 border-purple-500 pl-4">
                        <div class="font-semibold text-violet-300">Step ${step.step}</div>
                        <div class="text-sm text-gray-300">
                            ${step.instruction || step.description || 'No instruction'}
                        </div>
                        ${step.startingStitchCount ? `<div class="text-xs text-gray-500">Stitches: ${step.startingStitchCount} → ${step.endingStitchCount}</div>` : ''}
                    </div>
                `;
            });
            
            if (pattern.steps.length > 5) {
                html += `<div class="text-gray-500 italic">... and ${pattern.steps.length - 5} more steps</div>`;
            }
            
            html += '</div></div>';
            
            return html;
        }

        // Update progress indicators
        function updateProgress(step) {
            // Reset all steps
            document.querySelectorAll('[id^="step"]').forEach(el => {
                el.className = el.className.replace('text-purple-400', 'text-gray-500');
                const circle = el.querySelector('div');
                circle.className = circle.className.replace('bg-purple-600', 'bg-gray-600');
            });
            
            document.querySelectorAll('[id^="progress"]').forEach(el => {
                el.className = el.className.replace('bg-purple-600', 'bg-gray-600');
            });
            
            // Update current step
            for (let i = 1; i <= step; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.className = stepEl.className.replace('text-gray-500', 'text-purple-400');
                const circle = stepEl.querySelector('div');
                circle.className = circle.className.replace('bg-gray-600', 'bg-purple-600');
                
                if (i < step) {
                    const progress = document.getElementById(`progress${i}`);
                    progress.className = progress.className.replace('bg-gray-600', 'bg-purple-600');
                }
            }
        }

        // Show error message
        function showError(message) {
            validationResults.innerHTML = `
                <div class="bg-red-900 border border-red-500 rounded p-4 mb-4">
                    <h4 class="font-semibold text-red-200 mb-2"><i class="fas fa-exclamation-triangle"></i> Error</h4>
                    <p class="text-red-300">${message}</p>
                </div>
            `;
        }

        // Event listeners
        validateBtn.addEventListener('click', () => {
            const jsonText = jsonTextarea.value.trim();
            if (!jsonText) {
                showError('Please paste your pattern JSON first');
                return;
            }
            
            const { pattern, errors, warnings } = validatePattern(jsonText);
            showValidationResults(errors, warnings);
            
            if (errors.length === 0) {
                validatedPattern = pattern;
                previewContent.innerHTML = generatePreview(pattern);
                previewSection.classList.remove('hidden');
                updateProgress(2);
            }
        });

        backBtn.addEventListener('click', () => {
            previewSection.classList.add('hidden');
            uploadSection.classList.add('hidden');
            updateProgress(1);
        });

        proceedBtn.addEventListener('click', async () => {
            if (!currentUser) {
                showError('Please sign in first');
                return;
            }
            
            if (!validatedPattern) {
                showError('Please validate your pattern first');
                return;
            }
            
            try {
                updateProgress(3);
                uploadSection.classList.remove('hidden');
                uploadStatus.innerHTML = '<div class="text-blue-300"><i class="fas fa-spinner fa-spin"></i> Uploading pattern to Firestore...</div>';
                
                // Create pattern document
                const patternRef = doc(collection(db, 'patterns'));
                uploadedPatternId = patternRef.id;
                
                const patternData = {
                    id: uploadedPatternId,
                    ...validatedPattern,
                    createdBy: currentUser.uid,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    visibility: 'private',
                    shareCount: 0,
                    viewCount: 0,
                    forkCount: 0,
                    tags: [],
                    lastExportedAt: null,
                    exportCount: 0
                };
                
                await setDoc(patternRef, patternData);
                
                uploadStatus.innerHTML = `
                    <div class="bg-green-900 border border-green-500 rounded p-4">
                        <h4 class="font-semibold text-green-200 mb-2"><i class="fas fa-check-circle"></i> Upload Successful!</h4>
                        <p class="text-green-300">Your pattern "${validatedPattern.metadata.name}" has been uploaded to Firestore.</p>
                        <p class="text-green-400 text-sm mt-1">Pattern ID: ${uploadedPatternId}</p>
                    </div>
                `;
                
                viewBtn.href = `/?pattern=${uploadedPatternId}`;
                uploadActions.classList.remove('hidden');
                
            } catch (error) {
                console.error('Upload error:', error);
                uploadStatus.innerHTML = `
                    <div class="bg-red-900 border border-red-500 rounded p-4">
                        <h4 class="font-semibold text-red-200 mb-2"><i class="fas fa-exclamation-triangle"></i> Upload Failed</h4>
                        <p class="text-red-300">${error.message}</p>
                    </div>
                `;
            }
        });

        confirmBtn.addEventListener('click', () => {
            uploadStatus.innerHTML = `
                <div class="bg-blue-900 border border-blue-500 rounded p-4">
                    <h4 class="font-semibold text-blue-200 mb-2"><i class="fas fa-check"></i> Pattern Saved</h4>
                    <p class="text-blue-300">Your pattern is now permanently saved in your collection!</p>
                </div>
            `;
            uploadActions.classList.add('hidden');
        });

        cancelBtn.addEventListener('click', async () => {
            if (!uploadedPatternId) return;
            
            try {
                uploadStatus.innerHTML = '<div class="text-yellow-300"><i class="fas fa-spinner fa-spin"></i> Deleting pattern...</div>';
                
                await deleteDoc(doc(db, 'patterns', uploadedPatternId));
                
                uploadStatus.innerHTML = `
                    <div class="bg-yellow-900 border border-yellow-500 rounded p-4">
                        <h4 class="font-semibold text-yellow-200 mb-2"><i class="fas fa-trash"></i> Pattern Deleted</h4>
                        <p class="text-yellow-300">The pattern has been removed from Firestore.</p>
                    </div>
                `;
                uploadActions.classList.add('hidden');
                uploadedPatternId = null;
                
            } catch (error) {
                console.error('Delete error:', error);
                uploadStatus.innerHTML = `
                    <div class="bg-red-900 border border-red-500 rounded p-4">
                        <h4 class="font-semibold text-red-200 mb-2"><i class="fas fa-exclamation-triangle"></i> Delete Failed</h4>
                        <p class="text-red-300">${error.message}</p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>